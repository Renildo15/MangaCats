{% extends "base_templates/base.html" %}
{% load tz %}
{% load static %}
{% block title %}MangaCats - Read{% endblock title %}
{% block head %}
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js" integrity="sha512-1/RvZTcCDEUjY/CypiMz+iqqtaoQfAITmNSJY17Myp4Ms5mdxPS5UV7iOfdZoxcGhzFbOm6sntTKJppjvuhg4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css" integrity="sha512-SbiR/eusphKoMVVXysTKG/7VseWii+Y3FdHrt0EpKgpToZeemhqHeZeLWLhJutz/2ut2Vw1uQEj2MbRF+TVBUA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'css/user_app/styles.css' %}">
    <script type="text/javascript">
        (function ($) {
            function tinymce4_init(selector) {
                var tinymce4_config = { setup: function (editor) { editor.on('change', function () { editor.save(); }); }, "language": "en", "directionality": "ltr", "cleanup_on_startup": true, "custom_undo_redo_levels": 20, "selector": "textarea.tinymce4-editor", "theme": "modern", "plugins": "\n            textcolor save link image media preview codesample contextmenu\n            table code lists fullscreen  insertdatetime  nonbreaking\n            contextmenu directionality searchreplace wordcount visualblocks\n            visualchars code fullscreen autolink lists  charmap print  hr\n            anchor pagebreak\n            ", "toolbar1": "\n            fullscreen preview bold italic underline | fontselect,\n            fontsizeselect  | forecolor backcolor | alignleft alignright |\n            aligncenter alignjustify | indent outdent | bullist numlist table |\n            | link image media | codesample |\n            ", "toolbar2": "\n            visualblocks visualchars |\n            charmap hr pagebreak nonbreaking anchor |  code |\n            ", "contextmenu": "formats | link image", "menubar": true, "statusbar": true }; if (typeof selector != 'undefined') { tinymce4_config['selector'] = selector; }
                tinymce.init(tinymce4_config);
            }
            tinymce4_init();
        })();

        tinymce.init({
            selector: '.form',
            inline: true,
            menubar: false
    });
  </script>
{{form_comment.media}}
{% endblock head %}
{% block content %}
{% for msg in messages %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{msg}}
            <button type="button" class="btn-close" data-bs-dismiss="alert" arial-label="close"></button>
        </div>
{% endfor %}
<div class="container">
    <div class="content content-pages">
        {% include "partials/pages.html" %}
        {% if pages %}
            <div>
                <h3>Comments ({{total_comments}})</h3>
                <hr>
                {% if comments %}
                    {% for comment in comments %}
                        <ul id="{{comment.id_comment}}">
                            {% if comment.user.profile.image_profile %}
                                <li>
                                    <img style="object-fit: cover; border-radius:50%" width="50" height="50"  src="{{comment.user.profile.image_profile.url}}" alt="">
                                </li>
                            {% else %}
                                <li>
                                {% load static %}   <img style="object-fit: cover; border-radius:50%" width="50" height="50"  src="{% static "/imgs/placeholder.jpg" %}" alt="load" />
                                </li>
                            {% endif %}
                            <li>{{comment.user}}</li>
                            <li class="comment" id="comment{{comment.id_comment}}" data-comment="{{comment.id_comment}}">{{comment.comment|safe}}</li>
                            <li>{{comment.date_created|timesince}}</li>
                            {% if perms.comment_app.change_commentchapter and request.user == comment.user%}
                                <li><a class="comment btn btn-warning" id="comment{{comment.id_comment}}" data-comment="{{comment.id_comment}}">Edit</a></li>
                                <form class="d-none d-flex" class="form" id="form-comment{{comment.id_comment}}" method="GET">
                                    <input class="form-control" class="edit" type="text" id="inputText{{comment.id_comment}}" value="{{comment.comment|safe}}">
                                    <button type="submit" class="btn btn-warning" id="edit{{comment.id_comment}}">Save Changes</i></button>
                                </form>
                            {% endif %}     
                            {% if perms.comment_app.delete_commentchapter and request.user.is_staff or request.user == comment.user%}
                                <li><a class="btn btn-primary" id="btn-delete" data-chapter="{{comment.id_comment}}">Delete</a></li>
                            {% endif %}
                        
                            {% if comment.replies.all %}
                                <h4 id="title-replies">Replies</h4>
                            {% endif %}
                            {% for reply in comment.replies.all %}
                                <ul id="{{reply.id_comment}}">
                                    {% if reply.user.profile.image_profile %}
                                        <li>
                                            <img style="object-fit: cover; border-radius:50%" width="50" height="50"  src="{{reply.user.profile.image_profile.url}}" alt="">
                                        </li>
                                    {% else %}
                                        <li>
                                        {% load static %}   <img style="object-fit: cover; border-radius:50%" width="50" height="50"  src="{% static "/imgs/placeholder.jpg" %}" alt="load" />
                                        </li>
                                    {% endif %}
                                    <li>{{reply.user}}</li>
                                    <li class="comment" id="comment{{reply.id_comment}}" data-chapter="{{reply.id_comment}}">{{reply.comment|safe}}</li>
                                    <li>{{reply.date_created|timesince}}</li>

                                    {% if perms.comment_app.change_commentmanga and request.user == reply.user%}
                                    <li><a class="comment btn btn-warning" id="comment{{reply.id_comment}}" data-comment="{{reply.id_comment}}">Edit</a></li>
                                    <form class="d-none d-flex" class="form" id="form-comment{{reply.id_comment}}" method="GET">
                                        <input class="form-control" class="edit" type="text" id="inputText{{reply.id_comment}}" value="{{reply.comment|safe}}">
                                        <button type="submit" class="btn btn-warning" id="edit{{reply.id_comment}}">Save Changes</i></button>
                                    </form>
                                    {% endif %}

                                    {% if perms.comment_app.delete_commentmanga and request.user.is_staff or request.user == reply.user %}
                                        <li><a class="btn btn-primary" id="btn-delete" data-delete="{{reply.id_comment}}">Delete</a></li>
                                    {% endif %}
                                </ul>
                            {% endfor %}
                            <p>
                                <button class="btn btn-primary collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample{{comment.id_comment}}" aria-expanded="false" aria-controls="collapseExample{{comment.id_comment}}">
                                Replay
                                </button>
                                <hr>
                            </p>
                            <div class="collapse" id="collapseExample{{comment.id_comment}}" style="">
                                <div class="card card-body">
                                    <form  method="POST" class="form" enctype="multipart/form-data">
                                        {% csrf_token %}
                                        <div class="form-group">
                                            {{form_comment.comment.errors}}
                                            <label for="">Comment:</label>
                                            {{form_comment.comment}}
                                        </div>
                                        <div>
                                            <input type="hidden" name="parent_id" value="{{ comment.id_comment }}">
                                            <input class="btn btn-primary" type="submit" value="Replay">
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </ul>
                    {% endfor %}
                {% else %}
                    <h4>Not exists comments</h4>
                {% endif %}
            </div>
            <div >
                <h3>Add your comment:</h3>
                <hr>
                <form  method="POST" class="form" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        {{form_comment.comment.errors}}
                        <label for="">Comment:</label>
                        {{form_comment.comment}}
                    </div>
                    <div>
                        <input class="btn btn-primary" type="submit" value="Comment"/>
                    </div>
                </form>
            </div>
        {% else %}

        {% endif %}
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<script type="text/javascript"> 
    $("a#btn-delete").on("click", function (e) {
        e.preventDefault();

        var comment_id = $(this).attr("data-delete");
        console.log(comment_id);

        $.ajax({
            type: 'GET',
            url: '{% url "comment:comment_chapter_delete" %}',
            data: {'comment_id': comment_id},
            datatype: "json",
            success: function(data){
                if(data.status == "delete"){
                    $("ul#" + comment_id).fadeOut("slow", function(){
                        $("ul#" + comment_id).remove();
                       
                    })
                }else{
                    console.log("Erro")
                }
            }
        })
    })


    $("a.comment").click(function () {
    
        var data_id = $(this).attr("data-comment");

        $("form#form-comment" + data_id).removeClass('d-none')
        $("a#comment" + data_id).addClass('d-none')

        $('button#edit' + data_id).on("click", function (e) {
            e.preventDefault();
            
            comment = $('input#inputText'+ data_id).val();
    
            $.ajax({
                type: 'GET',
                url: '{% url "comment:comment_chapter_edit" %}',
                data: {'data_id': data_id,'comment': comment,},
                datatype: "json",
                success: function (data) {
                    if (data.status == "update-item") {
                        $("form#form-comment" + data_id).addClass('d-none');
                        $("a#comment" + data_id).removeClass('d-none'); 
                        $("#comment" + data_id).html(data.comment); 
                    }  
                }
            }); 

        });
    });

</script>
{% endblock content %}